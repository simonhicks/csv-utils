#!/bin/bash

show_help() {
  echo ""
  echo "USAGE: $(basename $0) [-h] [-g group-by-col] -s sum-col"
  echo ""
  echo "  s sum-col      : the column to sum"
  echo "  g group-by-col : group the sum by this column"
  echo "  h              : print this help text"
  echo ""
}

GROUP_BY_COL=""
SUM_COL=""
while getopts "hg:s:" opt
do
  case "$opt" in
    h)
      show_help
      exit 0
      ;;
    s) SUM_COL="$OPTARG"
      ;;
    g) GROUP_BY_COL="$OPTARG"
      ;;
  esac
done
shift $((OPTIND-1))

if [ "$SUM_COL" == "" ]
then
  >&2 echo "ERROR: Missing mandatory argument -s"
  >&2 show_help
  exit 1
fi

if [ "$GROUP_BY_COL" != "" ]
then
  $(dirname $0)/columns $GROUP_BY_COL,$SUM_COL | awk -F, -v header=${GROUP_BY_COL} -v sumCol=${SUM_COL} '
NR!=1 {
  sums[$1] += $2
}
END {
  printf("%s,sum-of-%s", header, sumCol)
  print("")

  for (value in sums) {
    printf("%s,%s", value, sums[value])
    print("")
  }
}' -
else
  $(dirname $0)/columns $SUM_COL | awk -F, 'NR!=1 { sum += $0 } END { print sum }' -
fi
