#!/bin/bash

show_help() {
  echo ""
  echo "USAGE: $(basename $0) [-h] [-s sep] -g group-by-col"
  echo ""
  echo "  s sep          : the field separator used in the input data"
  echo "  g group-by-col : group the count by this column"
  echo "  h              : print this help text"
  echo ""
}

SEPARATOR=,

GROUP_BY_COL=""
while getopts "hg:s:" opt
do
  case "$opt" in
    h)
      show_help
      exit 0
      ;;
    s) SEPARATOR="$OPTARG"
      ;;
    g) GROUP_BY_COL="$OPTARG"
      ;;
  esac
done
shift $((OPTIND-1))

if [ "$GROUP_BY_COL" == "" ]
then
  >&2 echo "ERROR: Missing mandatory argument -g"
  >&2 show_help
  exit 1
fi

$(dirname $0)/columns -s $SEPARATOR $GROUP_BY_COL | awk -F $SEPARATOR -v header=${GROUP_BY_COL} '
NR==1 {
  if (header=="") {
    header=$0
  }
}
NR!=1 {
  counts[$0]+=1
}
END {
  print(header FS "count")

  for (line in counts) {
    if (line != "") {
      print(line FS counts[line])
    } else {
      print(" " FS counts[line])
    }
  }
}' -
